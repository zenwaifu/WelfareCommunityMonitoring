<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Aid Tracker | Digital Village</title>
    
    <link rel="stylesheet" href="../style.css"> 

    <style>
        .page-title { margin-bottom: 25px; color: #2b8fae; font-size: 28px; font-weight: 700; }
        
        .update-card { 
            background: #fff; 
            border: 2px solid #000; 
            border-radius: 15px; 
            padding: 30px; 
            box-shadow: 8px 8px 0px rgba(0,0,0,0.1);
            max-width: 800px;
        }

        .form-section-title {
            background: #f2f0f0;
            padding: 12px 20px;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 25px;
            border-left: 5px solid #7dc9e1;
            border-bottom: 1px solid #ddd;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .full-width { grid-column: span 2; }

        .field-group { display: flex; flex-direction: column; gap: 8px; }
        .field-group label { font-weight: 700; font-size: 13px; color: #444; text-transform: uppercase; }
        
        .form-input, .form-select {
            padding: 12px;
            border: 1px solid #000;
            border-radius: 8px;
            font-size: 16px;
            background: #f9f9f9;
        }

        .form-input:disabled {
            background: #eee;
            color: #666;
            cursor: not-allowed;
        }

        .btn-group {
            margin-top: 35px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .btn {
            padding: 12px 30px;
            border-radius: 30px;
            border: 2px solid #000;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-submit { background: #2ecc71; color: #fff; }
        .btn-submit:hover { background: #27ae60; transform: translateY(-2px); box-shadow: 4px 4px 0px rgba(0,0,0,0.1); }
        
        .btn-cancel { background: #f2f0f0; color: #000; }
        .btn-cancel:hover { background: #e0e0e0; transform: translateY(-2px); }

        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>

    <nav class="top-nav">
        <div class="nav-brand">DIGITAL VILLAGE</div>
        <div class="admin-profile">
            <div class="admin-info">
                <p class="admin-name" id="displayUserName">Admin Name</p>
                <p id="displayUserRole" style="font-size: 11px; font-weight: bold; opacity: 0.7; text-transform: uppercase;">STAFF</p>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="layout-body">
        <aside class="sidebar">
            <div class="menu-label">ADMIN PANEL</div>
            <a href="admindashboard.html" class="menu-item">Dashboard Summary</a>
            <a href="../shared/welfareregisterpage.html" class="menu-item">Register Welfare</a>
            <a href="../shared/viewapplications.html" class="menu-item">View Applicants</a>
            <a href="../shared/viewcomplaints.html" class="menu-item">Manage Complaints</a>
            <a href="aid-list.html" class="menu-item active">Aid Delivery List</a>
        </aside>

        <main class="main-content">
            <h2 class="page-title">Update Aid Tracker</h2>
            
            <div class="update-card">
                <div class="form-section-title">Delivery Progress #<span id="displayId">ID</span></div>
                
                <form id="updateForm">
                    <div class="form-grid">
                        <div class="field-group">
                            <label>Delivery ID</label>
                            <input type="text" id="deliveryId" class="form-input" disabled>
                        </div>
                        <div class="field-group">
                            <label>Recipient Name</label>
                            <input type="text" id="recipientName" class="form-input" disabled>
                        </div>
                        <div class="field-group">
                            <label>Aid Type</label>
                            <input type="text" id="aidType" class="form-input" disabled>
                        </div>
                        <div class="field-group">
                            <label>Current Status</label>
                            <select id="deliveryStatus" class="form-select" required>
                                <option value="Preparing">Preparing</option>
                                <option value="Shipped">Shipped</option>
                                <option value="Delivered">Delivered</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="field-group full-width">
                            <label>Internal Dispatch Notes</label>
                            <textarea id="notes" class="form-input" style="min-height: 80px;" placeholder="Add courier details or delivery time..."></textarea>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-cancel" onclick="location.href='aid-list.html'">Back to List</button>
                        <button type="submit" class="btn btn-submit">Save Changes</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        let currentId = "";

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Session Setup
            const sessionData = localStorage.getItem('currentUser');
            if (!sessionData) { window.location.href = '../login.html'; return; }
            const user = JSON.parse(sessionData);
            document.getElementById('displayUserName').innerText = user.fullName;
            document.getElementById('displayUserRole').innerText = user.role;

            // 2. Fetch Data from URL and Database
            const urlParams = new URLSearchParams(window.location.search);
            currentId = urlParams.get('id');
            
            const deliveries = JSON.parse(localStorage.getItem('delivery_db')) || [];
            const delivery = deliveries.find(d => d.id === currentId);

            if (delivery) {
                document.getElementById('displayId').innerText = delivery.id;
                document.getElementById('deliveryId').value = delivery.id;
                document.getElementById('recipientName').value = delivery.recipient;
                document.getElementById('aidType').value = delivery.type;
                document.getElementById('deliveryStatus').value = delivery.status;
            } else {
                alert("Delivery record not found!");
                window.location.href = 'aid-list.html';
            }
        });

        // 3. Update Database
        document.getElementById('updateForm').onsubmit = (e) => {
            e.preventDefault();
            
            const deliveries = JSON.parse(localStorage.getItem('delivery_db'));
            const newStatus = document.getElementById('deliveryStatus').value;
            
            const index = deliveries.findIndex(d => d.id === currentId);
            if (index !== -1) {
                deliveries[index].status = newStatus;
                // You could also save the notes to the DB object here if needed
                localStorage.setItem('delivery_db', JSON.stringify(deliveries));
                
                alert(`Delivery status updated to: ${newStatus}`);
                window.location.href = 'aid-list.html';
            }
        };

        function logout() {
            if(confirm('Logout?')) {
                localStorage.removeItem('currentUser');
                window.location.href = '../login.html'; 
            }
        }
    </script>
</body>
</html>