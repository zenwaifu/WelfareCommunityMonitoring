<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Application | Digital Village</title>
    
    <link rel="stylesheet" href="../style.css"> 

    <style>
        /* Specific styles for the Review Form */
        .card { background: #fff; border-radius: 15px; border: 2px solid #000; padding: 30px; box-shadow: 8px 8px 0px rgba(0,0,0,0.1); }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        .review-header h1 { font-size: 28px; color: #2b8fae; }
        .status-badge { background: #fef3c7; color: #92400e; padding: 5px 15px; border-radius: 20px; border: 1px solid #92400e; font-weight: 700; font-size: 14px; text-transform: uppercase; }

        .section-title { background: #f2f0f0; padding: 10px 20px; font-size: 18px; font-weight: 700; margin: 25px 0 15px 0; border-left: 5px solid #7dc9e1; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-row { grid-column: span 2; }
        
        .field-group { display: flex; flex-direction: column; gap: 5px; }
        .field-group label { font-weight: 600; font-size: 13px; color: #666; text-transform: uppercase; }
        .field-group input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; font-size: 16px; color: #333; cursor: not-allowed; }

        .approval-box { margin-top: 40px; padding: 25px; border: 2px dashed #96afb8; border-radius: 12px; background: #fcfdfe; }
        .remarks-area { width: 100%; padding: 15px; border-radius: 8px; border: 1px solid #000; margin-bottom: 20px; font-size: 16px; min-height: 100px; resize: vertical; }
        
        .action-btns { display: flex; gap: 20px; }
        .btn { flex: 1; padding: 15px; border: 2px solid #000; border-radius: 30px; font-weight: 700; font-size: 18px; cursor: pointer; transition: 0.3s; }
        .btn-approve { background-color: #2ecc71; color: white; opacity: 0.5; cursor: not-allowed; }
        .btn-reject { background-color: #ef4141; color: white; }
        .btn-reject:hover { background-color: #d63031; transform: translateY(-2px); }
        .btn-approve.active { opacity: 1; cursor: pointer; }
        .btn-approve.active:hover { background-color: #27ae60; transform: translateY(-2px); box-shadow: 4px 4px 0px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <nav class="top-nav">
        <div class="nav-brand">DIGITAL VILLAGE</div>
        <div class="admin-profile">
            <div class="admin-info">
                <p class="admin-name" id="displayUserName">Admin Name</p>
                <p id="displayUserRole" style="font-size: 11px; font-weight: bold; opacity: 0.7; text-transform: uppercase;">Role</p>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="layout-body">
        <aside class="sidebar">
            <div class="menu-label">ADMIN PANEL</div>
            <a href="admindashboard.html" class="menu-item"><span>Dashboard Summary</span></a>
            <a href="../shared/welfareregisterpage.html" class="menu-item"><span>Register Welfare</span></a>
            <a href="../shared/viewapplications.html" class="menu-item active"><span>View Applicants</span></a>
            <a href="../shared/viewcomplaints.html" class="menu-item"><span>Manage Complaints</span></a>
            <a href="../shared/aidtracker.html" class="menu-item">Aid Delivery List</a>
        </aside>

        <main class="main-content">
            <div class="card">
                <div class="review-header">
                    <h1 id="appIdTitle">Review: #ID</h1>
                    <span class="status-badge" id="appStatusBadge">PENDING</span>
                </div>
                
                <h3 class="section-title">Personal Details</h3>
                <div class="info-grid">
                    <div class="field-group full-row">
                        <label>Full Name</label>
                        <input type="text" id="viewFullName" readonly>
                    </div>
                    <div class="field-group">
                        <label>IC Number</label>
                        <input type="text" value="850612-01-5543" readonly>
                    </div>
                    <div class="field-group">
                        <label>Application Date</label>
                        <input type="text" id="viewDate" readonly>
                    </div>
                    <div class="field-group full-row">
                        <label>Welfare Category / Aid Type</label>
                        <input type="text" id="viewAidType" readonly>
                    </div>
                </div>

                <div class="approval-box">
                    <h3 style="margin-bottom: 15px;">Official Decision</h3>
                    <textarea class="remarks-area" id="adminRemarks" placeholder="Enter internal notes or reasons for rejection..."></textarea>
                    
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 25px; cursor: pointer; font-weight: 500;">
                        <input type="checkbox" id="confirmCheck" style="width: 20px; height: 20px;">
                        <span>I confirm that all documents have been verified against JKM records.</span>
                    </label>

                    <div class="action-btns">
                        <button class="btn btn-approve" id="approveBtn" disabled>Approve Application</button>
                        <button class="btn btn-reject" onclick="handleDecision('Rejected')">Reject</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentAppId = "";

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Session & Profile Management
            const sessionData = localStorage.getItem('currentUser');
            if (!sessionData) {
                window.location.href = '../login.html';
                return;
            }
            const user = JSON.parse(sessionData);
            document.getElementById('displayUserName').innerText = user.fullName;
            document.getElementById('displayUserRole').innerText = user.role;

            // 2. Data Retrieval Logic
            const urlParams = new URLSearchParams(window.location.search);
            currentAppId = urlParams.get('id');

            const apps = JSON.parse(localStorage.getItem('welfare_db')) || [];
            const selectedApp = apps.find(a => a.id === currentAppId);

            if (selectedApp) {
                document.getElementById('appIdTitle').innerText = `Review: #${selectedApp.id}`;
                document.getElementById('appStatusBadge').innerText = selectedApp.status;
                document.getElementById('viewFullName').value = selectedApp.name;
                document.getElementById('viewAidType').value = selectedApp.type;
                document.getElementById('viewDate').value = selectedApp.date;
            } else {
                alert("Application not found!");
                window.location.href = '../shared/viewapplications.html';
            }
        });

        // 3. Verification & Button Activation
        const checkbox = document.getElementById('confirmCheck');
        const approveBtn = document.getElementById('approveBtn');

        checkbox.addEventListener('change', function() {
            approveBtn.disabled = !this.checked;
            approveBtn.classList.toggle('active', this.checked);
        });

        // 4. Handle Decision Logic
        approveBtn.onclick = () => handleDecision('Approved');

        function handleDecision(newStatus) {
            const remarks = document.getElementById('adminRemarks').value;
            
            if(newStatus === 'Rejected' && !remarks) {
                alert('Please provide a reason for rejection in the remarks area.');
                return;
            }

            if(confirm(`Confirm ${newStatus} for ${currentAppId}?`)) {
                let apps = JSON.parse(localStorage.getItem('welfare_db'));
                
                // Update the status in the local array
                const index = apps.findIndex(a => a.id === currentAppId);
                if (index !== -1) {
                    apps[index].status = newStatus;
                    localStorage.setItem('welfare_db', JSON.stringify(apps));
                }

                alert(`Application ${newStatus} successfully.`);
                window.location.href = '../shared/viewapplications.html';
            }
        }

        function logout() {
            if(confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                window.location.href = '../login.html'; 
            }
        }
    </script>
</body>
</html>